# frozen_string_literal: true

require 'rake/clean'

# Append all lines from `from` to `to` with the specified indention
def append_and_indent! from:, to:, indention:
  File.foreach from do |line|
    File.open(to, 'a') { |f| f << "#{' ' * indention}#{line}" }
  end
end

CLEAN.include '*.js', '_*'
CLOBBER.include '*.html'

##
# Build
#
file 'app.js' do
  sh 'opal --compile -I node_modules --gem opal-jquery app.rb > app.js'
end

file 'index.html' => 'app.js' do
  sh 'cp index.haml _index.haml'
  append_and_indent! :from => 'app.js', :to => '_index.haml', :indention => 4
  sh 'haml _index.haml > index.html'
end

desc 'Builds the app into index.html'
task :build => 'index.html'

task :build_and_clean => %i[build clean]

task :default => :build_and_clean

##
# Specs
#
require 'rake/testtask'

Rake::TestTask.new :test => :build_and_clean do |t|
  ENV['PATH'] = [ENV['PATH'], "#{Dir.home}/.webdrivers"].join ':'

  t.libs << 'spec'
  t.libs << 'lib'
  t.test_files = FileList['spec/**/*_spec.rb']

  # Supress `circular require` error messages from minitest
  t.warning = false
end

require 'webdrivers'
load 'webdrivers/Rakefile'
